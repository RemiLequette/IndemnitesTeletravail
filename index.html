<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Indemnités télétravail</title>
  <style>
    :root {
      color-scheme: light;
      font-family: Arial, sans-serif;
    }

    body {
      margin: 0;
      padding: 24px;
      background: #f5f7fb;
      color: #1f2937;
    }

    .container {
      max-width: 760px;
      margin: 0 auto;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 16px;
      font-size: 1.4rem;
    }

    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .control {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 180px;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
    }

    select,
    input[type="text"],
    input[type="number"] {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 0.95rem;
      background: #fff;
    }

    .summary {
      margin: 10px 0 14px;
      font-size: 0.95rem;
      color: #374151;
    }

    .days-list {
      list-style: none;
      padding: 0;
      margin: 0;
      border-top: 1px solid #e5e7eb;
    }

    .days-list li {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 4px;
      border-bottom: 1px solid #f0f2f5;
    }

    .tag {
      margin-left: auto;
      font-size: 0.8rem;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1>Jours travaillés (mois sélectionné)</h1>

    <div class="controls">
      <div class="control">
        <label for="nomUtilisateur">Nom de l'utilisateur</label>
        <input
          id="nomUtilisateur"
          type="text"
          placeholder="Ex. Rémi Lequette"
          aria-label="Nom de l'utilisateur"
        />
      </div>

      <div class="control">
        <label for="mois">Mois</label>
        <select id="mois" aria-label="Sélection du mois"></select>
      </div>

      <div class="control">
        <label for="annee">Année</label>
        <select id="annee" aria-label="Sélection de l'année"></select>
      </div>

      <div class="control">
        <label for="forfaitJournalier">Forfait journalier (€)</label>
        <input
          id="forfaitJournalier"
          type="number"
          inputmode="decimal"
          min="0"
          step="0.01"
          value="2.70"
          aria-label="Forfait journalier"
        />
      </div>

      <div class="control">
        <label for="maxMensuel">Max mensuel (€)</label>
        <input
          id="maxMensuel"
          type="number"
          inputmode="decimal"
          min="0"
          step="0.01"
          value="59.40"
          aria-label="Maximum mensuel"
        />
      </div>
    </div>

    <p id="utilisateurInfo" class="summary"></p>

    <p id="resume" class="summary"></p>

    <ul id="jours" class="days-list"></ul>
  </main>

  <script>
    const moisSelect = document.getElementById('mois');
    const anneeSelect = document.getElementById('annee');
    const nomUtilisateurInput = document.getElementById('nomUtilisateur');
    const forfaitJournalierInput = document.getElementById('forfaitJournalier');
    const maxMensuelInput = document.getElementById('maxMensuel');
    const utilisateurInfo = document.getElementById('utilisateurInfo');
    const joursContainer = document.getElementById('jours');
    const resume = document.getElementById('resume');
    const CLE_NOM_UTILISATEUR = 'indemnites_teletravail_nom_utilisateur';

    const moisNoms = [
      'janvier', 'février', 'mars', 'avril', 'mai', 'juin',
      'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'
    ];

    function formatDate(date) {
      return new Intl.DateTimeFormat('fr-FR', {
        weekday: 'long',
        day: '2-digit',
        month: 'long',
        year: 'numeric'
      }).format(date);
    }

    function calculerPaques(annee) {
      const a = annee % 19;
      const b = Math.floor(annee / 100);
      const c = annee % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const l = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * l) / 451);
      const mois = Math.floor((h + l - 7 * m + 114) / 31);
      const jour = ((h + l - 7 * m + 114) % 31) + 1;

      return new Date(annee, mois - 1, jour);
    }

    function ajouterJours(baseDate, jours) {
      const copy = new Date(baseDate);
      copy.setDate(copy.getDate() + jours);
      return copy;
    }

    function formatCle(date) {
      const annee = date.getFullYear();
      const mois = String(date.getMonth() + 1).padStart(2, '0');
      const jour = String(date.getDate()).padStart(2, '0');
      return `${annee}-${mois}-${jour}`;
    }

    function joursFeriesFrance(annee) {
      const paques = calculerPaques(annee);

      const fixes = [
        new Date(annee, 0, 1),   // Jour de l'an
        new Date(annee, 4, 1),   // Fête du Travail
        new Date(annee, 4, 8),   // Victoire 1945
        new Date(annee, 6, 14),  // Fête nationale
        new Date(annee, 7, 15),  // Assomption
        new Date(annee, 10, 1),  // Toussaint
        new Date(annee, 10, 11), // Armistice
        new Date(annee, 11, 25)  // Noël
      ];

      const mobiles = [
        ajouterJours(paques, 1),   // Lundi de Pâques
        ajouterJours(paques, 39),  // Ascension
        ajouterJours(paques, 50)   // Lundi de Pentecôte
      ];

      return new Set([...fixes, ...mobiles].map(formatCle));
    }

    function estWeekend(date) {
      const jour = date.getDay();
      return jour === 0 || jour === 6;
    }

    function remplirSelecteurs() {
      moisSelect.innerHTML = '';
      anneeSelect.innerHTML = '';

      moisNoms.forEach((nom, index) => {
        const option = document.createElement('option');
        option.value = String(index);
        option.textContent = nom.charAt(0).toUpperCase() + nom.slice(1);
        moisSelect.appendChild(option);
      });

      const anneeCourante = new Date().getFullYear();
      for (let annee = anneeCourante - 5; annee <= anneeCourante + 2; annee += 1) {
        const option = document.createElement('option');
        option.value = String(annee);
        option.textContent = String(annee);
        anneeSelect.appendChild(option);
      }
    }

    function nomUtilisateurCourant() {
      return nomUtilisateurInput.value.trim();
    }

    function afficherUtilisateur() {
      const nom = nomUtilisateurCourant();
      utilisateurInfo.textContent = nom
        ? `Utilisateur : ${nom}`
        : 'Utilisateur : non renseigné';
    }

    function sauvegarderNomUtilisateur() {
      const nom = nomUtilisateurCourant();
      localStorage.setItem(CLE_NOM_UTILISATEUR, nom);
      afficherUtilisateur();
    }

    function initialiserNomUtilisateur() {
      const nomSauvegarde = localStorage.getItem(CLE_NOM_UTILISATEUR);
      if (nomSauvegarde) {
        nomUtilisateurInput.value = nomSauvegarde;
      }
      afficherUtilisateur();
    }

    function lireMontant(input, valeurParDefaut) {
      const brut = input.value.trim().replace(',', '.');
      const montant = Number.parseFloat(brut);
      if (!Number.isFinite(montant) || montant < 0) {
        return valeurParDefaut;
      }
      return montant;
    }

    function formaterEuro(montant) {
      return new Intl.NumberFormat('fr-FR', {
        style: 'currency',
        currency: 'EUR'
      }).format(montant);
    }

    function compterJoursCoches() {
      return joursContainer.querySelectorAll('input[type="checkbox"]:checked').length;
    }

    function calculerMontantMensuel() {
      const nbJoursCoches = compterJoursCoches();
      const forfaitJournalier = lireMontant(forfaitJournalierInput, 2.7);
      const maxMensuel = lireMontant(maxMensuelInput, 59.4);
      const brut = nbJoursCoches * forfaitJournalier;
      const montant = Math.min(brut, maxMensuel);

      const mois = Number(moisSelect.value);
      const annee = Number(anneeSelect.value);

      resume.textContent = `${nbJoursCoches} jour(s) coché(s) pour ${moisNoms[mois]} ${annee} · Montant mensuel : ${formaterEuro(montant)} (plafond ${formaterEuro(maxMensuel)}).`;
    }

    function afficherJours() {
      const mois = Number(moisSelect.value);
      const annee = Number(anneeSelect.value);
      const nbJours = new Date(annee, mois + 1, 0).getDate();
      const feries = joursFeriesFrance(annee);

      joursContainer.innerHTML = '';
      for (let jour = 1; jour <= nbJours; jour += 1) {
        const date = new Date(annee, mois, jour);
        const cle = formatCle(date);
        const weekend = estWeekend(date);
        const ferie = feries.has(cle);
        const cocheParDefaut = !weekend && !ferie;

        const li = document.createElement('li');

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `jour-${cle}`;
        checkbox.checked = cocheParDefaut;
        checkbox.addEventListener('change', calculerMontantMensuel);

        const label = document.createElement('label');
        label.htmlFor = checkbox.id;
        label.textContent = formatDate(date);

        li.appendChild(checkbox);
        li.appendChild(label);

        if (weekend || ferie) {
          const tag = document.createElement('span');
          tag.className = 'tag';
          if (weekend && ferie) {
            tag.textContent = 'Week-end / Férié';
          } else if (weekend) {
            tag.textContent = 'Week-end';
          } else {
            tag.textContent = 'Férié';
          }
          li.appendChild(tag);
        }

        joursContainer.appendChild(li);
      }

      calculerMontantMensuel();
    }

    function initialiserMoisPrecedent() {
      const aujourdHui = new Date();
      const moisPrecedent = new Date(aujourdHui.getFullYear(), aujourdHui.getMonth() - 1, 1);

      moisSelect.value = String(moisPrecedent.getMonth());
      anneeSelect.value = String(moisPrecedent.getFullYear());
    }

    remplirSelecteurs();
    initialiserNomUtilisateur();
    initialiserMoisPrecedent();
    afficherJours();

    moisSelect.addEventListener('change', afficherJours);
    anneeSelect.addEventListener('change', afficherJours);
    forfaitJournalierInput.addEventListener('input', calculerMontantMensuel);
    forfaitJournalierInput.addEventListener('change', calculerMontantMensuel);
    maxMensuelInput.addEventListener('input', calculerMontantMensuel);
    maxMensuelInput.addEventListener('change', calculerMontantMensuel);
    nomUtilisateurInput.addEventListener('input', sauvegarderNomUtilisateur);
    nomUtilisateurInput.addEventListener('change', sauvegarderNomUtilisateur);
  </script>
</body>
</html>
