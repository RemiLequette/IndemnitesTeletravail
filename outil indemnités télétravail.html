<!DOCTYPE html>
<!--
  Objectif de l'application : calculer les indemnités de télétravail selon les règles et paramètres saisis.
  Répertoire GitHub : https://github.com/RemiLequette/IndemnitesTeletravail
-->
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='6' y='10' width='52' height='48' rx='10' fill='%232563eb'/%3E%3Crect x='10' y='20' width='44' height='34' rx='6' fill='white'/%3E%3Crect x='10' y='20' width='44' height='10' rx='6' fill='%23bfdbfe'/%3E%3Crect x='18' y='6' width='6' height='12' rx='3' fill='%231d4ed8'/%3E%3Crect x='40' y='6' width='6' height='12' rx='3' fill='%231d4ed8'/%3E%3Cpath d='M20 39l7 7 17-17' fill='none' stroke='%2316a34a' stroke-width='5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E" />
  <title>Indemnités télétravail</title>
  <style>
    :root {
      color-scheme: light;
      font-family: Arial, sans-serif;
    }

    body {
      margin: 0;
      padding: 24px;
      background: #f5f7fb;
      color: #1f2937;
    }

    .container {
      max-width: 760px;
      margin: 0 auto;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 16px;
      font-size: 1.4rem;
    }

    .toolbar-button {
      border: 1px solid #d1d5db;
      background: #fff;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.92rem;
      align-self: end;
    }

    .toolbar-button.active {
      background: #e5f0ff;
      border-color: #93c5fd;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .control {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 180px;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
    }

    select,
    input[type="text"],
    input[type="number"] {
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 0.95rem;
      background: #fff;
    }

    .summary {
      margin: 10px 0 14px;
      font-size: 0.95rem;
      color: #374151;
    }

    .calendar-wrap {
      overflow-x: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #fff;
    }

    .calendar-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
    }

    .calendar-table th,
    .calendar-table td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
    }

    .calendar-table th {
      background: #f8fafc;
      font-size: 0.85rem;
    }

    .week-label,
    .week-total {
      font-weight: 700;
      background: #f9fafb;
    }

    .day-empty {
      background: #ffffff;
    }

    .day-non-ouvre {
      background: #f3f4f6;
    }

    .day-check {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .day-number {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .day-type {
      font-size: 0.72rem;
      color: #6b7280;
    }

    .primary-button {
      border: 1px solid #1d4ed8;
      background: #2563eb;
      color: #fff;
      border-radius: 8px;
      padding: 9px 14px;
      font-size: 0.92rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <main class="container">
    <h1 id="pageTitle">Indemnités télétravail</h1>

    <div class="controls">
      <button id="toggleParametresBtn" type="button" class="toolbar-button">Paramètres</button>
    </div>

    <section id="tabPrincipal" class="tab-content active">
      <div class="controls">
        <div class="control">
          <label for="beneficiaire">Bénéficiaire</label>
          <input id="beneficiaire" type="text" placeholder="Ex. Rémi Lequette" aria-label="Bénéficiaire" />
        </div>

        <div class="control">
          <label for="mois">Mois</label>
          <select id="mois" aria-label="Sélection du mois"></select>
        </div>

        <div class="control">
          <label for="annee">Année</label>
          <select id="annee" aria-label="Sélection de l'année"></select>
        </div>

        <button id="genererPdfBtn" type="button" class="primary-button">Générer le PDF</button>
      </div>

      <p id="resume" class="summary"></p>

      <div class="calendar-wrap">
        <div id="jours"></div>
      </div>

    </section>

    <section id="tabParametres" class="tab-content">
      <div class="controls">
        <div class="control">
          <label for="forfaitJournalier">Forfait journalier (€)</label>
          <input
            id="forfaitJournalier"
            type="number"
            inputmode="decimal"
            min="0"
            step="0.01"
            value="2.70"
            aria-label="Forfait journalier"
          />
        </div>

        <div class="control">
          <label for="maxMensuel">Max mensuel (€)</label>
          <input
            id="maxMensuel"
            type="number"
            inputmode="decimal"
            min="0"
            step="0.01"
            value="59.40"
            aria-label="Maximum mensuel"
          />
        </div>

        <div class="control">
          <label for="fonction">Fonction</label>
          <input
            id="fonction"
            type="text"
            value="Président (Mandataire social non rémunéré)"
            aria-label="Fonction"
          />
        </div>

        <div class="control">
          <label for="societe">Nom de la société</label>
          <input id="societe" type="text" placeholder="Ex. Ma Société SAS" aria-label="Nom de la société" />
        </div>

        <div class="control">
          <label for="lieu">Lieu</label>
          <input id="lieu" type="text" placeholder="Ex. Paris" aria-label="Lieu" />
        </div>
      </div>
    </section>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script>
    const toggleParametresBtn = document.getElementById('toggleParametresBtn');
    const pageTitle = document.getElementById('pageTitle');
    const tabPrincipal = document.getElementById('tabPrincipal');
    const tabParametres = document.getElementById('tabParametres');

    const moisSelect = document.getElementById('mois');
    const anneeSelect = document.getElementById('annee');
    const beneficiaireInput = document.getElementById('beneficiaire');
    const forfaitJournalierInput = document.getElementById('forfaitJournalier');
    const maxMensuelInput = document.getElementById('maxMensuel');
    const fonctionInput = document.getElementById('fonction');
    const societeInput = document.getElementById('societe');
    const lieuInput = document.getElementById('lieu');

    const joursContainer = document.getElementById('jours');
    const resume = document.getElementById('resume');
    const genererPdfBtn = document.getElementById('genererPdfBtn');

    const CLES = {
      beneficiaire: 'indemnites_teletravail_beneficiaire',
      forfaitJournalier: 'indemnites_teletravail_forfait_journalier',
      maxMensuel: 'indemnites_teletravail_max_mensuel',
      fonction: 'indemnites_teletravail_fonction',
      societe: 'indemnites_teletravail_societe',
      lieu: 'indemnites_teletravail_lieu'
    };

    const moisNoms = [
      'janvier', 'février', 'mars', 'avril', 'mai', 'juin',
      'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre'
    ];

    function formatDate(date) {
      return new Intl.DateTimeFormat('fr-FR', {
        weekday: 'long',
        day: '2-digit',
        month: 'long',
        year: 'numeric'
      }).format(date);
    }

    function formatDateCourte(date) {
      return new Intl.DateTimeFormat('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      }).format(date);
    }

    function calculerPaques(annee) {
      const a = annee % 19;
      const b = Math.floor(annee / 100);
      const c = annee % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const l = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * l) / 451);
      const mois = Math.floor((h + l - 7 * m + 114) / 31);
      const jour = ((h + l - 7 * m + 114) % 31) + 1;

      return new Date(annee, mois - 1, jour);
    }

    function ajouterJours(baseDate, jours) {
      const copy = new Date(baseDate);
      copy.setDate(copy.getDate() + jours);
      return copy;
    }

    function formatCle(date) {
      const annee = date.getFullYear();
      const mois = String(date.getMonth() + 1).padStart(2, '0');
      const jour = String(date.getDate()).padStart(2, '0');
      return `${annee}-${mois}-${jour}`;
    }

    function joursFeriesFrance(annee) {
      const paques = calculerPaques(annee);

      const fixes = [
        new Date(annee, 0, 1),   // Jour de l'an
        new Date(annee, 4, 1),   // Fête du Travail
        new Date(annee, 4, 8),   // Victoire 1945
        new Date(annee, 6, 14),  // Fête nationale
        new Date(annee, 7, 15),  // Assomption
        new Date(annee, 10, 1),  // Toussaint
        new Date(annee, 10, 11), // Armistice
        new Date(annee, 11, 25)  // Noël
      ];

      const mobiles = [
        ajouterJours(paques, 1),   // Lundi de Pâques
        ajouterJours(paques, 39),  // Ascension
        ajouterJours(paques, 50)   // Lundi de Pentecôte
      ];

      return new Set([...fixes, ...mobiles].map(formatCle));
    }

    function estWeekend(date) {
      const jour = date.getDay();
      return jour === 0 || jour === 6;
    }

    function remplirSelecteurs() {
      moisSelect.innerHTML = '';
      anneeSelect.innerHTML = '';

      moisNoms.forEach((nom, index) => {
        const option = document.createElement('option');
        option.value = String(index);
        option.textContent = nom.charAt(0).toUpperCase() + nom.slice(1);
        moisSelect.appendChild(option);
      });

      const anneeCourante = new Date().getFullYear();
      for (let annee = anneeCourante - 5; annee <= anneeCourante + 2; annee += 1) {
        const option = document.createElement('option');
        option.value = String(annee);
        option.textContent = String(annee);
        anneeSelect.appendChild(option);
      }
    }

    function afficherOnglet(onglet) {
      const principalActif = onglet === 'principal';
      toggleParametresBtn.classList.toggle('active', !principalActif);
      toggleParametresBtn.textContent = principalActif ? 'Paramètres' : 'Retour';
      tabPrincipal.classList.toggle('active', principalActif);
      tabParametres.classList.toggle('active', !principalActif);
    }

    function valeurTexte(input) {
      return input.value.trim();
    }

    function beneficiaireCourant() {
      return valeurTexte(beneficiaireInput);
    }

    function afficherBeneficiaire() {
      const beneficiaire = beneficiaireCourant();
      pageTitle.textContent = beneficiaire
        ? `Indemnités télétravail - ${beneficiaire}`
        : 'Indemnités télétravail';

      if (!beneficiaire) {
        beneficiaireInput.placeholder = 'Ex. Rémi Lequette';
      }
    }

    function lireMontant(input, valeurParDefaut) {
      const brut = input.value.trim().replace(',', '.');
      const montant = Number.parseFloat(brut);
      if (!Number.isFinite(montant) || montant < 0) {
        return valeurParDefaut;
      }
      return montant;
    }

    function formaterEuro(montant) {
      return new Intl.NumberFormat('fr-FR', {
        style: 'currency',
        currency: 'EUR'
      }).format(montant);
    }

    function formaterMontantFacture(montant) {
      return new Intl.NumberFormat('fr-FR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(montant);
    }

    function compterJoursCoches() {
      return joursContainer.querySelectorAll('input[type="checkbox"]:checked').length;
    }

    function mettreAJourTotauxSemaines() {
      const cellulesTotal = joursContainer.querySelectorAll('[data-week-total]');
      cellulesTotal.forEach((cellule) => {
        const semaine = cellule.dataset.weekTotal;
        const total = joursContainer.querySelectorAll(`input[type="checkbox"][data-week="${semaine}"]:checked`).length;
        cellule.textContent = String(total);
      });
    }

    function calculerMontantCourant() {
      const nbJoursCoches = compterJoursCoches();
      const forfaitJournalier = lireMontant(forfaitJournalierInput, 2.7);
      const maxMensuel = lireMontant(maxMensuelInput, 59.4);
      const brut = nbJoursCoches * forfaitJournalier;
      const montant = Math.min(brut, maxMensuel);
      return {
        nbJoursCoches,
        forfaitJournalier,
        maxMensuel,
        montant
      };
    }

    function calculerMontantMensuel() {
      const { nbJoursCoches, forfaitJournalier, maxMensuel, montant } = calculerMontantCourant();

      const mois = Number(moisSelect.value);
      const annee = Number(anneeSelect.value);

      resume.textContent = `${nbJoursCoches} jour(s) à ${formaterEuro(forfaitJournalier)} pour ${moisNoms[mois]} ${annee} · Montant mensuel : ${formaterEuro(montant)} (plafond ${formaterEuro(maxMensuel)}).`;
    }

    function normaliserPourNomFichier(texte) {
      const normalise = texte
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z0-9]+/g, '_')
        .replace(/^_+|_+$/g, '');

      return normalise || 'BENEFICIAIRE';
    }

    function construireNomFichierPdf() {
      const mois = Number(moisSelect.value) + 1;
      const annee = Number(anneeSelect.value);
      const beneficiaire = normaliserPourNomFichier(beneficiaireCourant());
      return `NoteFrais_Teletravail_${annee}-${String(mois).padStart(2, '0')}_${beneficiaire}.pdf`;
    }

    function estJourCoche(annee, mois, jour) {
      const cle = `${annee}-${String(mois + 1).padStart(2, '0')}-${String(jour).padStart(2, '0')}`;
      const checkbox = document.getElementById(`jour-${cle}`);
      return checkbox ? checkbox.checked : false;
    }

    function construireTableauSemaines(annee, mois, nbJours) {
      const premierJour = new Date(annee, mois, 1);
      const decalagePremierJour = (premierJour.getDay() + 6) % 7;
      const semaines = [];

      for (let jour = 1; jour <= nbJours; jour += 1) {
        const position = decalagePremierJour + jour - 1;
        const indexSemaine = Math.floor(position / 7);
        const indexJourSemaine = position % 7;

        if (!semaines[indexSemaine]) {
          semaines[indexSemaine] = {
            jours: ['', '', '', '', '', '', ''],
            total: 0
          };
        }

        const coche = estJourCoche(annee, mois, jour);
        semaines[indexSemaine].jours[indexJourSemaine] = coche ? `${jour} ✓` : `${jour}`;
        if (coche) {
          semaines[indexSemaine].total += 1;
        }
      }

      return semaines;
    }

    function genererLignesTableauPdf() {
      const mois = Number(moisSelect.value);
      const annee = Number(anneeSelect.value);
      const nbJours = new Date(annee, mois + 1, 0).getDate();
      const semaines = construireTableauSemaines(annee, mois, nbJours);

      const lignes = semaines.map((semaine, index) => {
        const jours = semaine.jours.map((valeur) => valeur || '');
        return [`S${index + 1}`, ...jours, String(semaine.total)];
      });

      const totalMois = lignes.reduce((acc, ligne) => acc + Number(ligne[8] || 0), 0);
      lignes.push(['TOTAL MOIS', '', '', '', '', '', '', '', String(totalMois)]);
      return lignes;
    }

    function genererPdf() {
      if (!window.jspdf || !window.jspdf.jsPDF) {
        alert('La librairie PDF est indisponible. Vérifiez votre connexion Internet puis réessayez.');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });

      const nomFichier = construireNomFichierPdf();
      const mois = Number(moisSelect.value);
      const annee = Number(anneeSelect.value);
      const { nbJoursCoches, forfaitJournalier, maxMensuel, montant } = calculerMontantCourant();

      const beneficiaire = beneficiaireCourant() || '[BÉNÉFICIAIRE]';
      const societe = valeurTexte(societeInput) || '[NOM DE VOTRE SAS]';
      const fonction = valeurTexte(fonctionInput) || '[FONCTION]';
      const lieu = valeurTexte(lieuInput) || '[LIEU]';
      const dateDuJour = formatDateCourte(new Date());

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(13);
      doc.text('NOTE DE FRAIS : REMBOURSEMENT FORFAITAIRE TÉLÉTRAVAIL', 14, 16);

      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10.5);
      let y = 24;
      doc.text(`Société : ${societe}`, 14, y); y += 6;
      doc.text(`Bénéficiaire : ${beneficiaire}`, 14, y); y += 6;
      doc.text(`Fonction : ${fonction}`, 14, y); y += 6;
      doc.text(`Période : Mois de ${moisNoms[mois]} ${annee}`, 14, y); y += 8;

      doc.setFont('helvetica', 'bold');
      doc.text('1. Relevé des jours de présence à domicile', 14, y); y += 5;
      doc.setFont('helvetica', 'normal');
      doc.text('Conformément aux nécessités de gestion de la société exercées depuis le domicile du mandataire.', 14, y); y += 3;

      doc.autoTable({
        startY: y + 2,
        head: [['Semaine', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim', 'Total']],
        body: genererLignesTableauPdf(),
        styles: { font: 'helvetica', fontSize: 9, cellPadding: 2.2 },
        headStyles: { fillColor: [243, 244, 246], textColor: [17, 24, 39] },
        theme: 'grid'
      });

      y = doc.lastAutoTable.finalY + 10;
      doc.setFont('helvetica', 'bold');
      doc.text("2. Calcul de l'allocation forfaitaire", 14, y); y += 5;
      doc.setFont('helvetica', 'normal');
      doc.text("Base : Barème d'évaluation forfaitaire des frais de télétravail (admis par l'administration).", 14, y); y += 6;
      doc.text(`Nombre de jours travaillés à domicile : ${nbJoursCoches} jours`, 14, y); y += 6;
      doc.text(`Indemnité forfaitaire par jour : ${formaterEuro(forfaitJournalier)}`, 14, y); y += 6;
      doc.setFont('helvetica', 'bold');
      doc.text(`MONTANT TOTAL À REMBOURSER : ${formaterEuro(montant)} (Plafond ${formaterEuro(maxMensuel)})`, 14, y); y += 9;

      const montantHt = montant;
      const tauxTva = 0;
      const montantTva = 0;
      const montantTtc = montantHt + montantTva;

      doc.setFont('helvetica', 'bold');
      doc.text('3. Récapitulation comptable (format facture)', 14, y); y += 5;
      doc.setFont('helvetica', 'normal');
      doc.text('Document de remboursement - TVA non applicable (0%).', 14, y); y += 3;

      doc.autoTable({
        startY: y + 2,
        head: [['Motif', 'Montant HT (€)', 'TVA (%)', 'Montant TVA (€)', 'Montant TTC (€)']],
        body: [
          [
            `Indemnité forfaitaire télétravail - ${moisNoms[mois]} ${annee}`,
            formaterMontantFacture(montantHt),
            formaterMontantFacture(tauxTva),
            formaterMontantFacture(montantTva),
            formaterMontantFacture(montantTtc)
          ],
          [
            'TOTAL',
            formaterMontantFacture(montantHt),
            formaterMontantFacture(tauxTva),
            formaterMontantFacture(montantTva),
            formaterMontantFacture(montantTtc)
          ]
        ],
        styles: { font: 'helvetica', fontSize: 9, cellPadding: 2.2 },
        headStyles: { fillColor: [243, 244, 246], textColor: [17, 24, 39] },
        theme: 'grid',
        columnStyles: {
          0: { cellWidth: 84 },
          1: { halign: 'right', cellWidth: 26 },
          2: { halign: 'right', cellWidth: 18 },
          3: { halign: 'right', cellWidth: 26 },
          4: { halign: 'right', cellWidth: 26 }
        },
        didParseCell(data) {
          if (data.row.index === 1) {
            data.cell.styles.fontStyle = 'bold';
          }
        }
      });

      y = doc.lastAutoTable.finalY + 8;

      doc.setFont('helvetica', 'bold');
      doc.text('4. Certification', 14, y); y += 5;
      doc.setFont('helvetica', 'normal');

      const paragraphe = `Je certifie sur l'honneur l'exactitude des informations ci-dessus et que ces frais ont été engagés exclusivement pour les besoins de l'activité de la société ${societe}.`;
      const lignesParagraphe = doc.splitTextToSize(paragraphe, 180);
      doc.text(lignesParagraphe, 14, y);
      y += lignesParagraphe.length * 5 + 4;

      doc.text(`Fait à : ${lieu}`, 14, y); y += 6;
      doc.text(`Le : ${dateDuJour}`, 14, y); y += 10;
      doc.text('Signature du bénéficiaire :', 14, y); y += 7;
      doc.text(beneficiaire, 14, y);

      doc.save(nomFichier);
    }

    function chargerParametres() {
      const beneficiaire = localStorage.getItem(CLES.beneficiaire);
      if (beneficiaire !== null) {
        beneficiaireInput.value = beneficiaire;
      }

      const forfaitJournalier = localStorage.getItem(CLES.forfaitJournalier);
      if (forfaitJournalier !== null) {
        forfaitJournalierInput.value = forfaitJournalier;
      }

      const maxMensuel = localStorage.getItem(CLES.maxMensuel);
      if (maxMensuel !== null) {
        maxMensuelInput.value = maxMensuel;
      }

      const fonction = localStorage.getItem(CLES.fonction);
      if (fonction !== null) {
        fonctionInput.value = fonction;
      }

      const societe = localStorage.getItem(CLES.societe);
      if (societe !== null) {
        societeInput.value = societe;
      }

      const lieu = localStorage.getItem(CLES.lieu);
      if (lieu !== null) {
        lieuInput.value = lieu;
      }
    }

    function sauvegarderParametre(cle, valeur) {
      localStorage.setItem(cle, valeur);
    }

    function afficherJours() {
      const mois = Number(moisSelect.value);
      const annee = Number(anneeSelect.value);
      const nbJours = new Date(annee, mois + 1, 0).getDate();
      const feries = joursFeriesFrance(annee);
      const joursNoms = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
      const premierJour = new Date(annee, mois, 1);
      const decalagePremierJour = (premierJour.getDay() + 6) % 7;

      joursContainer.innerHTML = '';
      const table = document.createElement('table');
      table.className = 'calendar-table';

      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');

      const thSemaine = document.createElement('th');
      thSemaine.textContent = 'Semaine';
      headRow.appendChild(thSemaine);

      joursNoms.forEach((nom) => {
        const th = document.createElement('th');
        th.textContent = nom;
        headRow.appendChild(th);
      });

      const thTotal = document.createElement('th');
      thTotal.textContent = 'Total';
      headRow.appendChild(thTotal);

      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      let jour = 1;
      let semaine = 1;

      while (jour <= nbJours) {
        const row = document.createElement('tr');

        const celluleSemaine = document.createElement('td');
        celluleSemaine.className = 'week-label';
        celluleSemaine.textContent = `S${semaine}`;
        row.appendChild(celluleSemaine);

        for (let indexJourSemaine = 0; indexJourSemaine < 7; indexJourSemaine += 1) {
          const cellule = document.createElement('td');

          const caseAvantDebutMois = semaine === 1 && indexJourSemaine < decalagePremierJour;
          if (caseAvantDebutMois || jour > nbJours) {
            cellule.className = 'day-empty';
            row.appendChild(cellule);
            continue;
          }

          const date = new Date(annee, mois, jour);
          const cle = formatCle(date);
          const weekend = estWeekend(date);
          const ferie = feries.has(cle);
          const cocheParDefaut = !weekend && !ferie;

          if (weekend || ferie) {
            cellule.classList.add('day-non-ouvre');
          }

          const wrapper = document.createElement('div');
          wrapper.className = 'day-check';

          const numero = document.createElement('span');
          numero.className = 'day-number';
          numero.textContent = String(jour);

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `jour-${cle}`;
          checkbox.dataset.week = String(semaine);
          checkbox.checked = cocheParDefaut;
          checkbox.addEventListener('change', () => {
            calculerMontantMensuel();
            mettreAJourTotauxSemaines();
          });

          wrapper.appendChild(numero);
          wrapper.appendChild(checkbox);

          if (weekend || ferie) {
            const typeJour = document.createElement('span');
            typeJour.className = 'day-type';
            if (weekend && ferie) {
              typeJour.textContent = 'WE / FÉ';
            } else if (weekend) {
              typeJour.textContent = 'WE';
            } else {
              typeJour.textContent = 'FÉ';
            }
            wrapper.appendChild(typeJour);
          }

          cellule.appendChild(wrapper);
          row.appendChild(cellule);
          jour += 1;
        }

        const celluleTotal = document.createElement('td');
        celluleTotal.className = 'week-total';
        celluleTotal.dataset.weekTotal = String(semaine);
        celluleTotal.textContent = '0';
        row.appendChild(celluleTotal);

        tbody.appendChild(row);
        semaine += 1;
      }

      table.appendChild(tbody);
      joursContainer.appendChild(table);

      mettreAJourTotauxSemaines();
      calculerMontantMensuel();
    }

    function initialiserMoisPrecedent() {
      const aujourdHui = new Date();
      const moisPrecedent = new Date(aujourdHui.getFullYear(), aujourdHui.getMonth() - 1, 1);

      moisSelect.value = String(moisPrecedent.getMonth());
      anneeSelect.value = String(moisPrecedent.getFullYear());
    }

    remplirSelecteurs();
    chargerParametres();
    initialiserMoisPrecedent();
    afficherOnglet('principal');
    afficherBeneficiaire();
    afficherJours();

    toggleParametresBtn.addEventListener('click', () => {
      if (tabPrincipal.classList.contains('active')) {
        afficherOnglet('parametres');
      } else {
        afficherOnglet('principal');
      }
    });

    moisSelect.addEventListener('change', () => {
      afficherJours();
    });
    anneeSelect.addEventListener('change', () => {
      afficherJours();
    });

    forfaitJournalierInput.addEventListener('input', () => {
      sauvegarderParametre(CLES.forfaitJournalier, forfaitJournalierInput.value);
      calculerMontantMensuel();
    });
    forfaitJournalierInput.addEventListener('change', () => {
      sauvegarderParametre(CLES.forfaitJournalier, forfaitJournalierInput.value);
      calculerMontantMensuel();
    });

    maxMensuelInput.addEventListener('input', () => {
      sauvegarderParametre(CLES.maxMensuel, maxMensuelInput.value);
      calculerMontantMensuel();
    });
    maxMensuelInput.addEventListener('change', () => {
      sauvegarderParametre(CLES.maxMensuel, maxMensuelInput.value);
      calculerMontantMensuel();
    });

    beneficiaireInput.addEventListener('input', () => {
      sauvegarderParametre(CLES.beneficiaire, beneficiaireInput.value);
      afficherBeneficiaire();
    });
    beneficiaireInput.addEventListener('change', () => {
      sauvegarderParametre(CLES.beneficiaire, beneficiaireInput.value);
      afficherBeneficiaire();
    });

    fonctionInput.addEventListener('input', () => {
      sauvegarderParametre(CLES.fonction, fonctionInput.value);
    });
    fonctionInput.addEventListener('change', () => {
      sauvegarderParametre(CLES.fonction, fonctionInput.value);
    });

    societeInput.addEventListener('input', () => {
      sauvegarderParametre(CLES.societe, societeInput.value);
    });
    societeInput.addEventListener('change', () => {
      sauvegarderParametre(CLES.societe, societeInput.value);
    });

    lieuInput.addEventListener('input', () => {
      sauvegarderParametre(CLES.lieu, lieuInput.value);
    });
    lieuInput.addEventListener('change', () => {
      sauvegarderParametre(CLES.lieu, lieuInput.value);
    });

    genererPdfBtn.addEventListener('click', genererPdf);
  </script>
</body>
</html>
